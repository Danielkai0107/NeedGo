# 聊天室清理配置說明

## 概述

系統會根據資料庫中的配置自動清理過期的聊天室。當任務結束後超過指定時間，系統會自動清空聊天紀錄並發送系統訊息。

## 配置位置

- **集合**: `system`
- **文檔 ID**: `DtLX3K2FgJEGWvguqplh`
- **欄位**: `chatCloseTimer`
- **單位**: 分鐘
- **預設值**: 1440 分鐘（24小時）

## 當前配置值

根據你的截圖，目前配置為：

```
chatCloseTimer: 1440 (分鐘，等於24小時)
```

## 功能特點

### 🔄 自動清理機制

- 每小時檢查一次所有聊天室
- 檢查任務是否已完成或過期超過配置時間
- 自動清空過期聊天室的所有訊息
- 發送個人化系統訊息

### ⚡ 緩存機制

- 配置值會緩存 5 分鐘，避免頻繁讀取資料庫
- 手動觸發清理時會自動清除緩存，確保使用最新配置

### 🛠️ 管理功能

在聊天室列表頁面提供兩個調試按鈕：

1. **⚙️ 系統配置**：查看當前配置值和緩存狀態
2. **🧹 清理聊天室**：手動觸發清理功能

## 系統訊息效果

清理後每個用戶會看到個人化的系統訊息：

```
你和 [對方姓名] 已失去聯繫，他可能取消了配對或刪除帳號。
```

## 時間轉換表

以下是常用時間對應的分鐘值：

- **5分鐘**：`5`
- **15分鐘**：`15`
- **30分鐘**：`30`
- **1小時**：`60`
- **2小時**：`120`
- **6小時**：`360`
- **12小時**：`720`
- **24小時**：`1440`
- **48小時**：`2880`
- **1週**：`10080`

## 如何修改配置

### 方法 1：通過 Firebase Console

1. 登入 Firebase Console
2. 進入 Firestore Database
3. 找到 `system` 集合
4. 點擊文檔 `DtLX3K2FgJEGWvguqplh`
5. 修改 `chatCloseTimer` 的值（記住單位是分鐘）
6. 儲存變更

### 方法 2：通過管理後台

如果你有自定義的管理後台，可以在那裡修改這個值。

## 注意事項

1. **時間單位**：配置值的單位是分鐘，不是小時
2. **即時生效**：修改配置後，最多 5 分鐘後會生效（由於緩存機制）
3. **最小值**：建議設定至少 60 分鐘（1小時），避免過於頻繁的清理
4. **錯誤處理**：如果無法讀取配置，系統會使用預設值 1440 分鐘（24小時）

## 測試建議

1. 在正式環境修改前，建議先在測試環境驗證
2. 可以將值設定得較小（如 60 分鐘）來快速測試效果
3. 使用聊天室列表的手動清理功能來即時測試

## 日誌監控

系統會記錄以下日誌：

- 配置讀取成功/失敗
- 緩存使用情況
- 清理執行結果
- 任務檢查詳情

查看這些日誌可以幫助監控系統運行狀況。
