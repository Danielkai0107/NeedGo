# 地圖任務過濾測試指南

本指南説明如何測試和驗證地圖上只顯示活躍任務，不顯示過期或已完成的任務。

## 🎯 修復內容

### 問題描述

- **修復前**：地圖上會顯示所有任務，包括已過期和已完成的任務
- **修復後**：地圖上只顯示活躍狀態的任務（開放中、已接受）

### 任務狀態說明

- ✅ **開放中 (open)** - 顯示在地圖上
- ✅ **已接受 (accepted)** - 顯示在地圖上
- ❌ **已完成 (completed)** - 不顯示在地圖上
- ❌ **已過期 (expired)** - 不顯示在地圖上

## 🧪 測試步驟

### 測試 1: 過期任務自動隱藏

1. **創建一個過去日期的任務**：

   - 設定任務日期為昨天或更早
   - 保存任務並確認它出現在地圖上

2. **等待系統檢查**：

   - 系統會定期檢查過期任務（每 30 秒）
   - 或者切換到其他頁面再回來觸發檢查

3. **驗證結果**：
   - ✅ 過期任務應該從地圖上消失
   - ✅ 在"我的活動"頁面中，該任務狀態變為"已過期"
   - ✅ 任務仍在"過去發布"分類中可見

### 測試 2: 手動設定過期任務

1. **在 Firebase Console 中手動設定**：

   ```json
   {
     "status": "expired",
     "isActive": false
   }
   ```

2. **刷新應用**：

   - 重新載入地圖頁面
   - 或者下拉刷新

3. **驗證結果**：
   - ✅ 該任務不應出現在地圖上

### 測試 3: 已完成任務隱藏

1. **設定任務為已完成**：

   ```json
   {
     "status": "completed"
   }
   ```

2. **驗證結果**：
   - ✅ 已完成任務不顯示在地圖上

### 測試 4: 不同視角測試

#### Parent 視角測試：

1. 創建任務並確認在地圖上顯示
2. 將任務設為過期
3. 確認過期任務從地圖上移除

#### Player 視角測試：

1. 切換到 Player 視角
2. 確認只能看到他人的活躍任務
3. 確認過期任務不會顯示

## 🔍 驗證要點

### 控制台日誌檢查

查看 Flutter 控制台輸出，應該看到：

```
🔍 過濾後的活躍任務數量: X
📍 Parent 視角 - 實際添加了 X 個活躍任務標記
🔍 檢查任務 taskId: 狀態=open/accepted
```

### 地圖標記數量

- **修復前**：標記數量 = 所有任務
- **修復後**：標記數量 = 只有活躍任務

### 任務狀態顯示

在 TaskDetailSheet 中應該能看到正確的任務狀態：

- 開放中任務：可以應徵
- 過期任務：顯示"已過期"狀態

## 📋 測試檢查清單

### 基本功能

- [ ] 新創建的任務正常顯示在地圖上
- [ ] 過期任務自動從地圖上消失
- [ ] 已完成任務不顯示在地圖上
- [ ] 系統自動檢查並更新過期任務狀態

### Parent 視角

- [ ] 只顯示我的活躍任務標記
- [ ] 過期的我的任務不顯示
- [ ] 系統地點標記正常顯示

### Player 視角

- [ ] 只顯示他人的活躍任務
- [ ] 不顯示自己的任務
- [ ] 不顯示過期的任務

### 狀態同步

- [ ] 任務過期後狀態正確更新
- [ ] 地圖標記與任務列表狀態一致
- [ ] 切換視角後過濾邏輯正確

## 🛠️ 故障排除

### 如果過期任務仍然顯示：

1. 檢查任務的`date`字段格式是否正確
2. 確認`isActive`字段是否正確設置
3. 重新啟動應用強制刷新

### 如果活躍任務不顯示：

1. 檢查任務是否有地理位置信息
2. 確認任務狀態不是`completed`或`expired`
3. 檢查控制台日誌中的過濾信息

### 如果自動過期檢查不工作：

1. 確認應用在前台運行
2. 檢查定時器是否正常啟動
3. 手動切換頁面觸發檢查

## ✅ 預期行為總結

正確實施後，地圖應該：

1. **只顯示活躍任務**（開放中、已接受）
2. **自動隱藏過期任務**
3. **不顯示已完成任務**
4. **即時更新任務狀態**
5. **保持視角切換邏輯正確**

這確保用戶在地圖上只看到相關的、可操作的任務，提升用戶體驗。
