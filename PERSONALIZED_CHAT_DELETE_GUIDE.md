# 個人化聊天刪除功能說明

## 概述

改進了聊天室的刪除功能，從原本的全局刪除改為個人化刪除。現在每個用戶可以單獨隱藏自己的聊天室，而不會影響對方的聊天室顯示。

## 主要改進

### 🔒 個人化刪除機制

- **原本**：一方刪除聊天室後，雙方都看不到該聊天室
- **現在**：每個用戶可以單獨隱藏聊天室，只影響自己的聊天列表

### 🔄 智能恢復機制

- **任務進行中**：如果任務還在進行中，用戶刪除聊天室後再次點擊聊天按鈕會自動恢復
- **任務已完成/過期**：如果任務已完成或過期，刪除後無法再次恢復

### 📱 用戶體驗優化

- 刪除操作更加直觀，只影響當前用戶
- 提供恢復選項，避免誤刪的困擾
- 根據任務狀態智能決定是否可恢復

## 技術實現

### 資料庫結構變更

在 `chats` 集合中添加了 `hiddenBy` 字段：

```javascript
{
  // ... 其他字段
  "hiddenBy": ["userId1", "userId2"] // 隱藏此聊天室的用戶ID列表
}
```

### 核心功能

#### 1. 個人化隱藏

```dart
// 將當前用戶添加到 hiddenBy 列表
await _firestore.collection('chats').doc(chatId).update({
  'hiddenBy': FieldValue.arrayUnion([currentUser.uid]),
});
```

#### 2. 智能恢復

```dart
// 檢查任務狀態並決定是否可恢復
final isActive = await isTaskActive(taskId);
if (isActive) {
  // 從 hiddenBy 列表中移除當前用戶
  await _firestore.collection('chats').doc(chatId).update({
    'hiddenBy': FieldValue.arrayRemove([currentUser.uid]),
  });
}
```

#### 3. 自動恢復

```dart
// 在 createOrGetChatRoom 中自動檢查並恢復被隱藏的聊天室
if (hiddenBy.contains(currentUser.uid)) {
  final restored = await smartRestoreChatRoom(chatId);
  // 根據任務狀態決定是否恢復
}
```

## 使用場景

### 場景一：任務進行中的聊天室刪除

1. 用戶點擊「刪除」聊天室
2. 聊天室從列表中消失（只對當前用戶隱藏）
3. 用戶再次點擊任務的聊天按鈕
4. 系統自動恢復聊天室（因為任務還在進行中）

### 場景二：任務已完成的聊天室刪除

1. 用戶點擊「刪除」聊天室
2. 聊天室從列表中消失（只對當前用戶隱藏）
3. 用戶再次點擊任務的聊天按鈕
4. 系統檢查任務已完成，不會恢復聊天室

### 場景三：恢復操作

1. 用戶在刪除後的 4 秒內點擊「恢復」按鈕
2. 如果任務還在進行中，聊天室會重新顯示
3. 如果任務已完成/過期，會提示無法恢復

## 好處

### 👥 用戶體驗

- 刪除操作不會影響對方
- 避免誤刪造成的困擾
- 提供更靈活的聊天室管理

### 🔧 系統穩定性

- 保留聊天歷史記錄
- 支持根據任務狀態的智能恢復
- 減少資料庫的硬刪除操作

### 📊 資料完整性

- 聊天紀錄完整保留
- 支持用戶個人化的視圖管理
- 便於後續的數據分析和統計

## 注意事項

1. **任務狀態檢查**：系統會檢查任務的 `status` 字段，只有 `active` 或 `pending` 狀態的任務才支持聊天室自動恢復

2. **資料庫索引**：新增的 `hiddenBy` 字段可能需要在 Firebase Console 中建立相應的索引

3. **兼容性**：舊有的聊天室會自動兼容新的功能，`hiddenBy` 字段默認為空陣列

4. **清理機制**：現有的過期聊天室清理機制仍然有效，會在任務完成後清理聊天記錄

## 未來擴展

- 可考慮添加「標記為重要」功能
- 支持批量隱藏/恢復操作
- 添加聊天室歸檔功能
- 支持按時間範圍過濾聊天室
